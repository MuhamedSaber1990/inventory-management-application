<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Products</title>
    <link rel="stylesheet" href="/css/app.css" />
  </head>

  <body class="auth-body">
    <div class="auth-wrapper">
      <div class="auth-card">
        <header class="auth-header">
          <h1>Products List</h1>
          <p>Your inventory items (<%= totalItems %> total)</p>
        </header>

        <div class="dashboard-actions right">
          <a href="/products/add" class="auth-btn">Add Product</a>
        </div>

        <!-- NEW: CONTROLS BAR (Search + Limit) -->
        <div class="controls-bar">
          
          <!-- 1. SEARCH FORM -->
          <form action="/products" method="GET" class="search-form">
            <!-- Keep current limit when searching -->
            <input type="hidden" name="limit" value="<%= currentLimit %>">
            <input 
              type="text" 
              name="search" 
              placeholder="Search..." 
              value="<%= typeof search !== 'undefined' ? search : '' %>" 
              class="search-input"
            >
            <button type="submit" class="search-btn">
              <!-- Magnifying Glass Icon -->
              <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </button>
          </form>

          <!-- 2. LIMIT SELECTOR (Updated) -->
          <form action="/products" method="GET" id="limitForm" class="limit-controls">
            <label for="limit" class="limit-label">Items per page:</label>
            <input type="hidden" name="page" value="1">
            
            <!-- IMPORTANT: Keep search term when changing limit -->
            <input type="hidden" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>">
            
            <!-- prettier-ignore -->
            <select name="limit" id="limit" class="limit-select"> 
              <option value="10" <%= currentLimit === 10 ? 'selected' : '' %>>10</option>
              <option value="20" <%= currentLimit === 20 ? 'selected' : '' %>>20</option>
              <option value="40" <%= currentLimit === 40 ? 'selected' : '' %>>40</option>
              <option value="80" <%= currentLimit === 80 ? 'selected' : '' %>>80</option>
            </select>
          </form>
        </div>

        <div class="dashboard-section">
          <% if (products && products.length > 0) { %>

            <div class="products-container">
              <table class="products-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Price (â‚¬)</th>
                    <th>Quantity</th>
                    <th>Description</th>
                    <th>Update</th>
                    <th>Delete</th>
                  </tr>
                </thead>

                <tbody>
                  <% products.forEach((product, index) => { %>
                    <tr>
                      <td class="id-cell">
                        <span class="id-pill">
                          <%= ((currentPage - 1) * currentLimit) + index + 1 %>
                        </span>
                      </td>

                      <td><%= product.name %></td>
                      <td><%= product.sku %></td>
                      <td><%= product.price %></td>
                      <td><%= product.quantity %></td>
                      <td><%= product.description %></td>

                      <td class="table-actions">
                        <a href="/products/edit/<%= product.id %>" class="table-btn">Update</a>
                      </td>

                      <td class="table-actions">
                        <form
                          action="/products/delete/<%= product.id %>"
                          method="POST"
                          class="delete-form"
                          data-name="<%= product.name %>"
                        >
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>" />

                          <button type="submit" class="table-btn table-btn-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>

          <% } else { %>
            <p class="no-products">
              No products found <%= typeof search !== 'undefined' && search ? `matching "${search}"` : '' %>.
            </p>
          <% } %>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
          <div class="pagination-wrapper">

            <!-- Previous -->
            <% if (currentPage > 1) { %>
              <a
                href="/products?page=<%= currentPage - 1 %>&limit=<%= currentLimit %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
                class="page-link"
              >
                &larr; Previous
              </a>
            <% } else { %>
              <span class="page-link disabled">&larr; Previous</span>
            <% } %>

            <!-- Smart Pagination Logic -->
            <% 
              let startPage, endPage;
              if (totalPages <= 7) {
                startPage = 1;
                endPage = totalPages;
              } else {
                if (currentPage <= 4) {
                  startPage = 1;
                  endPage = 5;
                } else if (currentPage + 3 >= totalPages) {
                  startPage = totalPages - 4;
                  endPage = totalPages;
                } else {
                  startPage = currentPage - 1;
                  endPage = currentPage + 1;
                }
              }
            %>

            <% if (totalPages > 7 && currentPage > 4) { %>
              <a href="/products?page=1&limit=<%= currentLimit %>&search=<%= typeof search !== 'undefined' ? search : '' %>" class="page-link">1</a>
              <span class="page-link dots">...</span>
            <% } %>

            <!-- Page numbers Loop (Updated with search param) -->
            <% for (let i = startPage; i <= endPage; i++) { %>
              <a
                href="/products?page=<%= i %>&limit=<%= currentLimit %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
                class="page-link <%= currentPage === i ? 'active' : '' %>"
              >
                <%= i %>
              </a>
            <% } %>

            <% if (totalPages > 7 && currentPage + 3 < totalPages) { %>
              <span class="page-link dots">...</span>
              <a href="/products?page=<%= totalPages %>&limit=<%= currentLimit %>&search=<%= typeof search !== 'undefined' ? search : '' %>" class="page-link"><%= totalPages %></a>
            <% } %>

            <!-- Next -->
            <% if (currentPage < totalPages) { %>
              <a
                href="/products?page=<%= currentPage + 1 %>&limit=<%= currentLimit %>&search=<%= typeof search !== 'undefined' ? search : '' %>"
                class="page-link"
              >
                Next &rarr;
              </a>
            <% } else { %>
              <span class="page-link disabled">Next &rarr;</span>
            <% } %>

          </div>
        <% } %>

        <footer class="auth-footer footer-actions">
          <a href="/dashboard" class="auth-btn">Back to Dashboard</a>
        </footer>
      </div>
    </div>

    <script src="/js/app.js"></script>
  </body>
</html>